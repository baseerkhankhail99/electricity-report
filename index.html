<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Electricity Consumption Report</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
        body {
            font-family: "Inter", sans-serif;
            background-color: #f0f2f5;
        }
        /* Custom styles for better aesthetics */
        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 2rem;
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .filter-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
            align-items: flex-end;
        }
        .filter-group {
            flex: 1;
            min-width: 150px;
        }
        .filter-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #333;
        }
        .filter-group select,
        .custom-select-trigger,
        .search-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #cbd5e1;
            border-radius: 0.5rem;
            background-color: #f8fafc;
            color: #333;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .filter-group select:focus,
        .custom-select-trigger:focus,
        .search-input:focus {
            outline: none;
            border-color: #4F46E5;
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2);
        }

        /* Custom Select & Search Styles */
        .custom-select-container {
            position: relative;
            width: 100%;
        }
        .custom-select-trigger {
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .custom-select-trigger::after {
            content: '▼';
            font-size: 0.7rem;
            margin-left: 0.5rem;
            color: #666;
            transition: transform 0.2s ease;
        }
        .custom-select-trigger.open::after {
            transform: rotate(180deg);
        }
        .custom-select-options {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: #ffffff;
            border: 1px solid #cbd5e1;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 10;
            max-height: 250px; /* Increased height */
            overflow-y: auto;
            padding: 0.5rem 0;
            margin-top: 0.25rem;
        }
        .custom-select-options.open {
            display: block;
        }
        .custom-select-option-item {
            display: flex;
            align-items: center;
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: background-color 0.1s ease;
        }
        .custom-select-option-item:hover {
            background-color: #f0f2f5;
        }
        .search-input {
            margin-bottom: 0.5rem; /* Space between search and options */
            padding: 0.6rem 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid #d1d5db;
        }

        .filter-checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        /* New class for the second line of checkboxes */
        .checkbox-row {
            grid-column: 1 / -1; /* Spans full width */
            display: flex;
            flex-wrap: wrap;
            gap: 1.5rem; /* Space between checkboxes */
            margin-top: 0.5rem; /* Space from filters above */
        }

        .btn-primary, .btn-secondary {
            background-image: linear-gradient(to right, #4F46E5, #6366F1);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
        }
        .btn-secondary {
            background-color: #e2e8f0;
            color: #4a5568;
            background-image: none; /* Override primary gradient */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        .btn-secondary:hover {
            transform: translateY(-2px);
            background-color: #cbd5e1;
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.1);
        }
        .button-group {
            grid-column: 1 / -1; /* Span across all columns for alignment */
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-top: 1rem;
            justify-content: flex-end; /* Align buttons to the right */
        }

        .report-table-wrapper {
            border-radius: 0.75rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            margin-top: 1.5rem;
            overflow-x: auto;
        }
        .report-table {
            width: 100%;
            border-collapse: collapse;
        }
        .report-table th,
        .report-table td {
            padding: 1rem 1.25rem;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
            white-space: normal;
            word-wrap: break-word;
        }
        .report-table thead th {
            background-color: #edf2f7;
            font-weight: 700;
            color: #4a5568;
            text-transform: uppercase;
            font-size: 0.875rem;
        }
        .report-table tbody tr:nth-child(even) {
            background-color: #f7fafc;
        }
        .report-table tbody tr:hover {
            background-color: #e2e8f0;
            transition: background-color 0.2s ease-in-out;
        }
        .no-data {
            text-align: center;
            padding: 2rem;
            color: #6b7280;
            font-size: 1.125rem;
        }
        .message-box {
            background-color: #fff3cd;
            color: #856404;
            padding: 1rem;
            border: 1px solid #ffeeba;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            text-align: center;
            font-weight: 500;
        }
        .summary-card {
            background-color: #e0f2fe;
            border: 1px solid #90cdf4;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-top: 1rem;
            text-align: center;
            font-weight: 600;
            color: #2c5282;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            text-align: left;
        }
        .summary-item {
            padding: 0.5rem;
            border-radius: 0.5rem;
            background-color: rgba(255,255,255,0.7);
            box-shadow: 0 1px 4px rgba(0,0,0,0.05);
        }
        .summary-item strong {
            display: block;
            margin-bottom: 0.25rem;
            color: #000;
        }
        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
            margin-top: 2rem;
            padding: 1.5rem;
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .positive-change { color: #16a34a; font-weight: 600; }
        .negative-change { color: #dc2626; font-weight: 600; }
        .no-change { color: #4b5563; }
        .anomaly-highlight {
            background-color: #fee2e2; /* Light red background */
            border: 1px solid #ef4444; /* Red border */
        }
        .anomaly-alerts {
            background-color: #fef2f2;
            border: 1px solid #fca5a5;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-top: 1.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        .anomaly-alerts h3 {
            color: #dc2626;
            font-weight: 700;
            margin-bottom: 0.75rem;
        }
        .anomaly-item {
            color: #b91c1c;
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
        }
        .anomaly-item:last-child {
            margin-bottom: 0;
        }

        /* Styles for bordered transformer headers */
        .report-table thead tr.transformer-row th {
            border: 1px solid #000; /* Black border for the top-level transformer cells */
            border-bottom: none; /* No bottom border for top row cells */
            text-align: center; /* Center align transformer names */
            vertical-align: middle;
        }
        .report-table thead tr.meter-row th {
            border: 1px solid #000; /* Black border for meter cells */
            border-top: none; /* No top border for second row cells */
            font-size: 0.75rem; /* Smaller font for meter names */
            padding: 0.5rem 1rem; /* Smaller padding */
            text-align: center;
        }
        .report-table thead th.month-header {
            border: 1px solid #000; /* Black border for Month header */
            text-align: left;
        }

        /* Print Specific Styles */
        @media print {
            body {
                background-color: #fff; /* White background for printing */
                margin: 0;
                padding: 0;
            }
            .container {
                max-width: 100%; /* Use full width for print */
                margin: 0;
                padding: 0.5cm; /* Reduced padding for print */
                box-shadow: none; /* No shadow in print */
                border-radius: 0; /* No border-radius in print */
            }
            .filter-section, .button-group, .checkbox-row { /* Hide filters and buttons when printing */
                display: none;
            }
            h1 {
                font-size: 1.5rem; /* Smaller title for print */
                margin-bottom: 1rem;
            }
            .message-box, .anomaly-alerts {
                display: none; /* Hide messages and alerts in print */
            }
            .summary-card {
                box-shadow: none;
                border: none;
                background-color: #fff;
                margin-top: 1rem;
                padding: 0.5rem;
            }
            .summary-item {
                box-shadow: none;
                background-color: #fff;
                padding: 0.25rem;
            }
            .report-table-wrapper {
                box-shadow: none;
                margin-top: 1rem;
                overflow-x: visible; /* Allow content to flow */
            }
            .report-table {
                font-size: 0.75rem; /* Smaller font for table */
                width: 100%; /* Ensure table takes full width */
                table-layout: fixed; /* Fixed layout to prevent overflow */
            }
            .report-table th,
            .report-table td {
                padding: 0.5rem 0.75rem; /* Smaller padding for table cells */
                border: 1px solid #ddd; /* Add borders for clarity in print */
            }
            .report-table thead th {
                background-color: #fff; /* White background for print headers */
            }
            .report-table thead tr.transformer-row th {
                border: 1px solid #000; /* Black border for print top headers */
                border-bottom: none;
            }
            .report-table thead tr.meter-row th {
                border: 1px solid #000; /* Black border for print sub-headers */
                border-top: none;
            }

            .chart-container {
                box-shadow: none;
                background-color: #fff;
                padding: 0;
                height: 350px; /* Adjust chart height for print */
                margin-top: 1rem;
            }
            /* Force page breaks for better layout */
            .chart-container, .report-table-wrapper, .summary-card {
                page-break-inside: avoid;
                page-break-after: auto;
            }
            .report-table tbody tr {
                page-break-inside: avoid;
            }
            @page {
                size: landscape; /* Request landscape orientation */
                margin: 0.5cm; /* Smaller margins for print */
            }
        }
    </style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 p-4 sm:p-6 lg:p-8">
<div class="container">
<h1 class="text-3xl font-bold text-center text-gray-800 mb-6">Electricity Consumption Report</h1>
<div class="message-box hidden" id="messageArea"></div>
<div class="filter-section">
<div class="filter-group" id="yearFilterGroup">
<label class="text-gray-700" for="yearFilter">Year:</label>
<select class="rounded-lg shadow-sm" id="yearFilter"></select>
</div>
<div class="filter-group" id="monthFilterGroup">
<label class="text-gray-700">Months:</label>
<div class="custom-select-container">
<div class="custom-select-trigger rounded-lg shadow-sm" id="monthSelectTrigger">
                        Select Months
                    </div>
<div class="custom-select-options" id="monthSelectOptions">
<input class="search-input" id="monthSearchInput" placeholder="Search months..." type="text"/>
</div>
</div>
</div>
<div class="filter-group">
<label class="text-gray-700">Meters:</label>
<div class="custom-select-container">
<div class="custom-select-trigger rounded-lg shadow-sm" id="meterSelectTrigger">
                        Select Meters
                    </div>
<div class="custom-select-options" id="meterSelectOptions">
<input class="search-input" id="meterSearchInput" placeholder="Search meters..." type="text"/>
</div>
</div>
</div>
<div class="filter-group">
<label class="text-gray-700" for="chartTypeFilter">Chart Type:</label>
<select class="rounded-lg shadow-sm" id="chartTypeFilter">
<option value="line">Line Chart</option>
<option value="bar">Bar Chart</option>
<option value="doughnut">Doughnut Chart</option>
<option value="pie">Pie Chart</option>
<option value="polarArea">Polar Area Chart</option>
<option value="radar">Radar Chart</option>
</select>
</div>
<div class="checkbox-row">
<div class="filter-group filter-checkbox-group">
<input class="rounded text-indigo-600 focus:ring-indigo-500" id="showChangeColumns" type="checkbox"/>
<label class="text-gray-700 font-normal" for="showChangeColumns">Show MoM/YoY Changes</label>
</div>
<div class="filter-group filter-checkbox-group">
<input class="rounded text-indigo-600 focus:ring-indigo-500" id="showSummaryMetrics" type="checkbox"/>
<label class="text-gray-700 font-normal" for="showSummaryMetrics">Show Summary Statistics</label>
</div>
<div class="filter-group filter-checkbox-group">
<input class="rounded text-red-600 focus:ring-red-500" id="showAnomalyDetection" type="checkbox"/>
<label class="text-gray-700 font-normal" for="showAnomalyDetection">Enable Anomaly Detection</label>
</div>
</div>
<div class="button-group">
<button class="btn-primary" id="applyFilters">Apply Filters</button>
<button class="btn-secondary" id="resetFiltersBtn">Reset Filters</button>
<button class="btn-secondary" id="downloadReportBtn">Download Filtered Data (Excel)</button>
<button class="btn-secondary" id="printReportBtn">Print Report</button>
</div>
</div>
<div class="anomaly-alerts hidden" id="anomalyAlerts">
<h3>⚠ Anomaly Alerts</h3>
<div id="anomalyList"></div>
</div>
<div class="summary-card hidden" id="summaryMetrics">
<h3 class="col-span-full text-center text-lg font-bold text-gray-800 mb-2">Summary Statistics (Filtered Data)</h3>
<div class="summary-item">
<strong>Overall Total Consumption:</strong> <span id="overallTotalConsumptionValue">0.00</span>
</div>
</div>
<div class="rounded-lg report-table-wrapper" id="reportContainer">
<table class="report-table" id="reportTable">
<thead>
<tr id="tableHeaderTransformerRow">
</tr>
<tr id="tableHeaderMeterRow">
</tr>
</thead>
<tbody id="tableBody">
<tr><td class="no-data" colspan="5">Loading data from Google Sheet...</td></tr>
</tbody>
</table>
</div>
<div class="chart-container hidden" id="chartSection">
<canvas id="consumptionChart"></canvas>
</div>
</div>
<script>
        // *** IMPORTANT: This URL is your Google Apps Script Web App URL, which acts as a CORS proxy. ***
        // It fetches the original Google Sheet CSV data and adds necessary CORS headers.
        const GOOGLE_SHEET_CSV_URL = 'https://proxy.cors.sh/' + encodeURIComponent('https://script.google.com/macros/s/AKfycbz7lidciBT-Yz4nesxZ1s23gDvnCMWxL60CpvENMUYorVtGoKBryb24zp-omMgPhjPszA/exec');
        const TARGET_SHEET_NAME = 'Monthly_Summary'; // This might not be used directly when fetching CSV via Apps Script, but kept for context

        let fullReportData = []; // Stores the entire parsed Google Sheet data with MoM/YoY
        let rawReportData = []; // Stores the raw parsed Google Sheet data before MoM/YoY calculations
        let availableMeters = []; // Stores the names of the consumption columns from the CSV headers

        let myChart; // Chart.js instance

        // Define the desired order of meters for display and chart labels
        const desiredMeterOrder = [
            'MAIN METER (T1) (Consumption)', 'CHECK METER (T1) (Consumption)',
            'MAIN METER (T2) (Consumption)', 'CHECK METER (T2) (Consumption)',
            'MAIN METER (T3) (Consumption)', 'CHECK METER (T3) (Consumption)',
            'MAIN METER (T4) (Consumption)', 'CHECK METER (T4) (Consumption)'
        ];

        // Chart.js color palette for multiple datasets (more distinct colors)
        const chartColors = [
            'rgba(79, 70, 229, 0.8)',    // Indigo Main
            'rgba(129, 140, 248, 0.8)', // Light Indigo Check
            'rgba(234, 88, 12, 0.8)',    // Orange Main
            'rgba(251, 146, 60, 0.8)',  // Light Orange Check
            'rgba(6, 182, 212, 0.8)',    // Cyan Main
            'rgba(45, 212, 191, 0.8)',  // Teal Check
            'rgba(168, 85, 247, 0.8)',  // Purple Main
            'rgba(192, 132, 252, 0.8)', // Light Purple Check
            'rgba(244, 63, 94, 0.8)',    // Rose Main
            'rgba(253, 164, 175, 0.8)'  // Light Rose Check
        ];
        const chartBorderColors = [
            'rgba(79, 70, 229, 1)',
            'rgba(129, 140, 248, 1)',
            'rgba(234, 88, 12, 1)',
            'rgba(251, 146, 60, 1)',
            'rgba(6, 182, 212, 1)',
            'rgba(45, 212, 191, 1)',
            'rgba(168, 85, 247, 1)',
            'rgba(192, 132, 252, 1)',
            'rgba(244, 63, 94, 1)',
            'rgba(253, 164, 175, 1)'
        ];

        // Anomaly detection threshold (percentage deviation from average of previous 3 months)
        const ANOMALY_THRESHOLD_PERCENT = 20;

        // Assign DOM elements
        const yearFilter = document.getElementById('yearFilter');
        const monthSelectTrigger = document.getElementById('monthSelectTrigger');
        const monthSelectOptions = document.getElementById('monthSelectOptions');
        const monthSearchInput = document.getElementById('monthSearchInput');
        const meterSelectTrigger = document.getElementById('meterSelectTrigger');
        const meterSelectOptions = document.getElementById('meterSelectOptions');
        const meterSearchInput = document.getElementById('meterSearchInput');
        const chartTypeFilter = document.getElementById('chartTypeFilter');
        const showChangeColumnsCheckbox = document.getElementById('showChangeColumns');
        const showSummaryMetricsCheckbox = document.getElementById('showSummaryMetrics');
        const showAnomalyDetectionCheckbox = document.getElementById('showAnomalyDetection');
        const applyFiltersBtn = document.getElementById('applyFilters');
        const resetFiltersBtn = document.getElementById('resetFiltersBtn');
        const downloadReportBtn = document.getElementById('downloadReportBtn');
        const printReportBtn = document.getElementById('printReportBtn');
        const reportTable = document.getElementById('reportTable');
        const tableHeaderTransformerRow = document.getElementById('tableHeaderTransformerRow');
        const tableHeaderMeterRow = document.getElementById('tableHeaderMeterRow');
        const tableBody = document.getElementById('tableBody');
        const messageArea = document.getElementById('messageArea');
        const summaryMetrics = document.getElementById('summaryMetrics');
        const overallTotalConsumptionValue = document.getElementById('overallTotalConsumptionValue');
        const chartSection = document.getElementById('chartSection');
        const consumptionChartCtx = document.getElementById('consumptionChart').getContext('2d');
        const anomalyAlerts = document.getElementById('anomalyAlerts');
        const anomalyList = document.getElementById('anomalyList');
        const yearFilterGroup = document.getElementById('yearFilterGroup');
        const monthFilterGroup = document.getElementById('monthFilterGroup');


        function showMessage(msg, type = 'warning') {
            messageArea.textContent = msg;
            messageArea.className = `message-box ${type === 'error' ? 'bg-red-100 text-red-700 border-red-200' : 'bg-yellow-100 text-yellow-700 border-yellow-200'}`;
            messageArea.classList.remove('hidden');
        }

        function hideMessage() {
            messageArea.classList.add('hidden');
        }

        /**
         * Calculates the linear regression trendline for a given set of data points.
         * @param {Array<Object>} dataPoints - Array of objects with 'x' (numeric) and 'y' (numeric) properties.
         * @returns {Array<Object>} Array of objects with 'x' and 'y' for the trendline.
         */
        function calculateLinearRegressionTrend(dataPoints) {
            if (dataPoints.length < 2) return [];

            const n = dataPoints.length;
            let sumX = 0;
            let sumY = 0;
            let sumXY = 0;
            let sumXX = 0;

            for (let i = 0; i < n; i++) {
                sumX += dataPoints[i].x;
                sumY += dataPoints[i].y;
                sumXY += dataPoints[i].x * dataPoints[i].y;
                sumXX += dataPoints[i].x * dataPoints[i].x;
            }

            const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
            const intercept = (sumY / n) - (slope * sumX) / n;

            // Generate trendline points across the range of x values
            const xMin = dataPoints[0].x;
            const xMax = dataPoints[n - 1].x;

            return [
                { x: xMin, y: intercept + slope * xMin },
                { x: xMax, y: intercept + slope * xMax }
            ];
        }

        // Function to calculate MoM and YoY changes for the full dataset
        function calculateMoMYoY(data) {
            console.log("calculateMoMYoY: Starting with data length", data.length);
            // Sort data by month to ensure correct previous/year-ago lookup
            data.sort((a, b) => new Date(a.Month) - new Date(b.Month));

            const dataMap = new Map(data.map(row => [row.Month, row]));
            console.log("calculateMoMYoY: dataMap created.");

            const processedData = data.map(row => {
                const currentDate = new Date(row.Month + '-01'); // Add -01 to make it a valid date for calculations
                const currentMonthStr = row.Month;

                const prevMonthDate = new Date(currentDate);
                prevMonthDate.setMonth(currentDate.getMonth() - 1);
                const prevMonthStr = `${prevMonthDate.getFullYear()}-${String(prevMonthDate.getMonth() + 1).padStart(2, '0')}`;
                const prevMonthRow = dataMap.get(prevMonthStr);

                const yearAgoDate = new Date(currentDate);
                yearAgoDate.setFullYear(currentDate.getFullYear() - 1);
                const yearAgoMonthStr = `${yearAgoDate.getFullYear()}-${String(yearAgoDate.getMonth() + 1).padStart(2, '0')}`;
                const yearAgoMonthRow = dataMap.get(yearAgoMonthStr);

                const newRow = { ...row };

                availableMeters.forEach(meter => {
                    const currentConsumption = parseFloat(row[meter]);

                    newRow[`${meter} MoM Change`] = 'N/A';
                    if (prevMonthRow && !isNaN(currentConsumption)) {
                        const prevConsumption = parseFloat(prevMonthRow[meter]);
                        if (!isNaN(prevConsumption)) {
                            if (prevConsumption !== 0) {
                                const momChange = ((currentConsumption - prevConsumption) / prevConsumption) * 100;
                                newRow[`${meter} MoM Change`] = momChange.toFixed(2) + '%';
                            } else if (currentConsumption !== 0) {
                                newRow[`${meter} MoM Change`] = 'Inf%';
                            } else {
                                newRow[`${meter} MoM Change`] = '0.00%';
                            }
                        }
                    }

                    newRow[`${meter} YoY Change`] = 'N/A';
                    if (yearAgoMonthRow && !isNaN(currentConsumption)) {
                        const yearAgoConsumption = parseFloat(yearAgoMonthRow[meter]);
                        if (!isNaN(yearAgoConsumption)) {
                            if (yearAgoConsumption !== 0) {
                                const yoyChange = ((currentConsumption - yearAgoConsumption) / yearAgoConsumption) * 100;
                                newRow[`${meter} YoY Change`] = yoyChange.toFixed(2) + '%';
                            } else if (currentConsumption !== 0) {
                                newRow[`${meter} YoY Change`] = 'Inf%';
                            } else {
                                newRow[`${meter} YoY Change`] = '0.00%';
                            }
                        }
                    }
                });
                return newRow;
            });
            console.log("calculateMoMYoY: Finished processing data. Result length:", processedData.length);
            return processedData;
        }

        // Function to populate filter dropdowns (including the custom month and meter dropdowns)
        function populateFilters(data) {
            console.log("populateFilters: Starting with data length", data.length);
            const years = new Set(['All']);
            const months = new Set();

            availableMeters = [];
            if (data.length > 0) {
                Object.keys(data[0]).forEach(key => {
                    if (key.includes('(Consumption)') && key !== 'Month') { // Only add columns explicitly marked as (Consumption)
                        availableMeters.push(key);
                    }
                });

                availableMeters.sort((a, b) => {
                    const indexA = desiredMeterOrder.indexOf(a);
                    const indexB = desiredMeterOrder.indexOf(b);

                    if (indexA === -1 && indexB === -1) return a.localeCompare(b); // Both not found, sort alphabetically
                    if (indexA === -1) return 1; // A not found, move A to end
                    if (indexB === -1) return -1; // B not found, move B to end
                    return indexA - indexB; // Sort by desired order
                });
            }
            console.log("populateFilters: availableMeters after sorting:", availableMeters);


            data.forEach(row => {
                const date = new Date(row.Month);
                years.add(date.getFullYear().toString());
                months.add(String(date.getMonth() + 1).padStart(2, '0'));
            });
            console.log("populateFilters: Years found:", Array.from(years));
            console.log("populateFilters: Months found (raw):", Array.from(months));

            const sortedYears = Array.from(years).sort((a, b) => {
                if (a === 'All') return -1;
                if (b === 'All') return 1;
                return parseInt(a) - parseInt(b);
            });
            const sortedMonths = Array.from(months).sort((a, b) => {
                if (a === 'All') return -1;
                if (b === 'All') return 1;
                return parseInt(a) - parseInt(b);
            });

            yearFilter.innerHTML = sortedYears.map(year => `<option value="${year}">${year}</option>`).join('');

            // Populate Custom Month Filter
            monthSelectOptions.innerHTML = `<input type="text" id="monthSearchInput" class="search-input" placeholder="Search months...">`;
            const allMonthOptionDiv = document.createElement('div');
            allMonthOptionDiv.className = 'custom-select-option-item';
            allMonthOptionDiv.innerHTML = `
                <input type="checkbox" id="month_all" value="All">
                <label for="month_all">All Months</label>
            `;
            monthSelectOptions.appendChild(allMonthOptionDiv);

            sortedMonths.forEach(monthNum => {
                if (monthNum === 'All') return; // Skip "All" as it's added separately
                const monthName = new Date(2000, parseInt(monthNum) - 1, 1).toLocaleString('default', { month: 'long' });
                const optionDiv = document.createElement('div');
                optionDiv.className = 'custom-select-option-item';
                optionDiv.innerHTML = `
                    <input type="checkbox" id="month_${monthNum}" value="${monthNum}">
                    <label for="month_${monthNum}">${monthName} (${monthNum})</label>
                `;
                monthSelectOptions.appendChild(optionDiv);
            });

            // Populate Custom Meter Filter
            meterSelectOptions.innerHTML = `<input type="text" id="meterSearchInput" class="search-input" placeholder="Search meters...">`;
            const allMeterOptionDiv = document.createElement('div');
            allMeterOptionDiv.className = 'custom-select-option-item';
            allMeterOptionDiv.innerHTML = `
                <input type="checkbox" id="meter_all" value="All">
                <label for="meter_all">All Meters</label>
            `;
            meterSelectOptions.appendChild(allMeterOptionDiv);


            availableMeters.forEach(meter => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'custom-select-option-item';
                optionDiv.innerHTML = `
                    <input type="checkbox" id="meter_${meter.replace(/[^a-zA-Z0-9]/g, '')}" value="${meter}">
                    <label for="meter_${meter.replace(/[^a-zA-Z0-9]/g, '')}">${meter.replace(' (Consumption)', '')}</label>
                `;
                meterSelectOptions.appendChild(optionDiv);
            });

            console.log("populateFilters: Filters populated.");
            setupCustomSelects();
        }

        function setupCustomSelects() {
            // Month Select
            monthSelectTrigger.addEventListener('click', () => {
                monthSelectOptions.classList.toggle('open');
                monthSelectTrigger.classList.toggle('open');
                if (monthSelectOptions.classList.contains('open')) {
                    monthSearchInput.focus();
                }
            });

            monthSelectOptions.addEventListener('change', (event) => {
                if (event.target.type === 'checkbox') {
                    if (event.target.value === 'All') {
                        // If "All Months" is checked/unchecked, toggle all others
                        monthSelectOptions.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                            if (cb !== event.target) {
                                cb.checked = event.target.checked;
                            }
                        });
                    } else {
                        // If any other month is unchecked, uncheck "All Months"
                        if (!event.target.checked) {
                            monthSelectOptions.querySelector('#month_all').checked = false;
                        }
                    }
                    updateSelectTriggerText(monthSelectTrigger, monthSelectOptions, 'Months');
                }
            });

            monthSearchInput.addEventListener('input', () => {
                const searchTerm = monthSearchInput.value.toLowerCase();
                monthSelectOptions.querySelectorAll('.custom-select-option-item').forEach(item => {
                    const label = item.querySelector('label');
                    if (label) {
                        const monthText = label.textContent.toLowerCase();
                        if (monthText.includes(searchTerm)) {
                            item.style.display = '';
                        } else {
                            item.style.display = 'none';
                        }
                    }
                });
            });

            // Meter Select
            meterSelectTrigger.addEventListener('click', () => {
                meterSelectOptions.classList.toggle('open');
                meterSelectTrigger.classList.toggle('open');
                if (meterSelectOptions.classList.contains('open')) {
                    meterSearchInput.focus();
                }
            });

            meterSelectOptions.addEventListener('change', (event) => {
                if (event.target.type === 'checkbox') {
                    if (event.target.value === 'All') {
                        // If "All Meters" is checked/unchecked, toggle all others
                        meterSelectOptions.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                            if (cb !== event.target) {
                                cb.checked = event.target.checked;
                            }
                        });
                    } else {
                        // If any other meter is unchecked, uncheck "All Meters"
                        if (!event.target.checked) {
                            meterSelectOptions.querySelector('#meter_all').checked = false;
                        }
                    }
                    updateSelectTriggerText(meterSelectTrigger, meterSelectOptions, 'Meters');
                }
            });

            meterSearchInput.addEventListener('input', () => {
                const searchTerm = meterSearchInput.value.toLowerCase();
                meterSelectOptions.querySelectorAll('.custom-select-option-item').forEach(item => {
                    const label = item.querySelector('label');
                    if (label) {
                        const meterText = label.textContent.toLowerCase();
                        if (meterText.includes(searchTerm)) {
                            item.style.display = '';
                        } else {
                            item.style.display = 'none';
                        }
                    }
                });
            });

            // Close custom selects when clicking outside
            document.addEventListener('click', (event) => {
                if (!monthSelectContainer.contains(event.target) && monthSelectOptions.classList.contains('open')) {
                    monthSelectOptions.classList.remove('open');
                    monthSelectTrigger.classList.remove('open');
                }
                if (!meterSelectContainer.contains(event.target) && meterSelectOptions.classList.contains('open')) {
                    meterSelectOptions.classList.remove('open');
                    meterSelectTrigger.classList.remove('open');
                }
            });
        }

        function updateSelectTriggerText(trigger, optionsContainer, defaultText) {
            const checkedCheckboxes = optionsContainer.querySelectorAll('input[type="checkbox"]:checked');
            if (checkedCheckboxes.length === 0) {
                trigger.textContent = `Select ${defaultText}`;
            } else if (checkedCheckboxes.length === optionsContainer.querySelectorAll('input[type="checkbox"]').length - 1 && optionsContainer.querySelector('input[value="All"]')) {
                trigger.textContent = `All ${defaultText}`;
            } else if (checkedCheckboxes.length === 1 && checkedCheckboxes[0].value === 'All') {
                trigger.textContent = `All ${defaultText}`;
            }
             else {
                const selectedValues = Array.from(checkedCheckboxes)
                    .filter(cb => cb.value !== 'All')
                    .map(cb => {
                        if (defaultText === 'Months') {
                            return new Date(2000, parseInt(cb.value) - 1, 1).toLocaleString('default', { month: 'short' });
                        } else if (defaultText === 'Meters') {
                            return cb.value.replace(' (Consumption)', '');
                        }
                        return cb.value;
                    });
                trigger.textContent = selectedValues.join(', ');
            }
        }

        // Function to fetch data from the Google Apps Script proxy
        async function fetchGoogleSheetData() {
            showMessage("Loading data from Google Sheet...", 'warning');
            tableBody.innerHTML = '<tr><td colspan="5" class="no-data">Loading data from Google Sheet...</td></tr>';
            try {
                const response = await fetch(GOOGLE_SHEET_CSV_URL);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Network response was not ok:', response.status, errorText);
                    showMessage(`Failed to load data. Server responded with status ${response.status}. Please check the Google Apps Script deployment and permissions.`, 'error');
                    return [];
                }

                const csvText = await response.text();
                console.log("Raw CSV Text Length:", csvText.length);
                
                // Attempt to parse the CSV. If it's a JSON error message, handle it.
                let parsedData;
                try {
                    parsedData = XLSX.read(csvText, { type: 'string' }).Sheets.Sheet1;
                    rawReportData = XLSX.utils.sheet_to_json(parsedData, { header: 1 }); // Read as array of arrays first

                    // Assuming the first row is headers, find the 'Month' column
                    const headers = rawReportData[0];
                    const monthColIndex = headers.indexOf('Month');
                    if (monthColIndex === -1) {
                        showMessage('CSV data missing "Month" column. Please ensure your Google Sheet has a "Month" column.', 'error');
                        return [];
                    }

                    // Transform array of arrays to array of objects using the first row as headers
                    rawReportData = rawReportData.slice(1).map(row => {
                        const obj = {};
                        headers.forEach((header, i) => {
                            obj[header] = row[i];
                        });
                        return obj;
                    });
                     console.log("Parsed raw report data (first 5 rows):", rawReportData.slice(0, 5));


                    // Validate data: Ensure 'Month' and consumption columns are present and data is numeric
                    if (rawReportData.length === 0) {
                        showMessage("No data found in the Google Sheet. Please ensure your sheet is not empty.", 'warning');
                        return [];
                    }

                    // Check if 'Month' column exists and is not empty
                    if (!rawReportData[0].hasOwnProperty('Month')) {
                        showMessage('Missing "Month" column in your Google Sheet. Please ensure the first column is named "Month".', 'error');
                        return [];
                    }

                    // Identify consumption columns and convert values to numbers
                    availableMeters = Object.keys(rawReportData[0]).filter(key => key.includes('(Consumption)'));
                    if (availableMeters.length === 0) {
                        showMessage('No consumption columns found (e.g., "METER1 (Consumption)"). Please ensure your meter columns are named correctly.', 'error');
                        return [];
                    }

                    rawReportData = rawReportData.map(row => {
                        const newRow = { ...row };
                        availableMeters.forEach(meter => {
                            newRow[meter] = parseFloat(row[meter]) || 0; // Convert to number, default to 0 if invalid
                        });
                        // Ensure Month is formatted YYYY-MM
                        if (newRow.Month) {
                             const dateParts = newRow.Month.split('-'); // Assumes YYYY-MM-DD or YYYY-MM format
                             if (dateParts.length >= 2) {
                                 newRow.Month = `${dateParts[0]}-${dateParts[1].padStart(2, '0')}`;
                             } else {
                                 // Attempt to parse if not already YYYY-MM format (e.g., if it's MM/DD/YYYY)
                                 const parsedDate = new Date(newRow.Month);
                                 if (!isNaN(parsedDate)) {
                                     newRow.Month = `${parsedDate.getFullYear()}-${String(parsedDate.getMonth() + 1).padStart(2, '0')}`;
                                 } else {
                                     console.warn(`Could not parse Month: ${row.Month}. Skipping row.`);
                                     return null; // Mark for filtering out
                                 }
                             }
                         }
                        return newRow;
                    }).filter(row => row !== null); // Filter out rows with unparseable months

                    fullReportData = calculateMoMYoY(rawReportData);
                    hideMessage();
                    populateFilters(rawReportData); // Use raw data for filter population as MoM/YoY are calculated later
                    applyFilters(); // Apply initial filters to display data
                    return fullReportData;

                } catch (jsonError) {
                    // This block catches if the CSV *was actually a JSON error message* from Apps Script
                    try {
                        const errorResponse = JSON.parse(csvText);
                        showMessage(`Apps Script Error: ${errorResponse.error}. Context: ${errorResponse.context || 'N/A'}`, 'error');
                    } catch (finalError) {
                        // If it's not valid JSON either, it's just raw unparseable text
                        showMessage(`Failed to parse data: ${csvText.substring(0, 200)}... It might not be valid CSV.`, 'error');
                    }
                    console.error("Parsing error:", jsonError);
                    return [];
                }

            } catch (error) {
                console.error("Fetch error:", error);
                showMessage(`Network error: ${error.message}. Please check your internet connection and the Apps Script URL.`, 'error');
                return [];
            }
        }


        // Function to filter and display data based on selections
        function applyFilters() {
            hideMessage();
            console.log("applyFilters: Starting...");

            const selectedYear = yearFilter.value;
            const selectedMonths = Array.from(monthSelectOptions.querySelectorAll('input[type="checkbox"]:checked'))
                                      .map(cb => cb.value)
                                      .filter(value => value !== 'All');
            const selectedMeters = Array.from(meterSelectOptions.querySelectorAll('input[type="checkbox"]:checked'))
                                    .map(cb => cb.value)
                                    .filter(value => value !== 'All');
            const showChange = showChangeColumnsCheckbox.checked;
            const showSummary = showSummaryMetricsCheckbox.checked;
            const enableAnomaly = showAnomalyDetectionCheckbox.checked;

            console.log("applyFilters: Filters - Year:", selectedYear, "Months:", selectedMonths, "Meters:", selectedMeters, "Show Change:", showChange, "Show Summary:", showSummary, "Enable Anomaly:", enableAnomaly);

            let filteredData = fullReportData.filter(row => {
                const rowYear = new Date(row.Month).getFullYear().toString();
                const rowMonth = String(new Date(row.Month).getMonth() + 1).padStart(2, '0');

                const yearMatch = selectedYear === 'All' || rowYear === selectedYear;
                const monthMatch = selectedMonths.length === 0 || selectedMonths.includes(rowMonth); // If no months selected, all match

                return yearMatch && monthMatch;
            });
            console.log("applyFilters: Data filtered by Year/Month. Length:", filteredData.length);

            // Dynamically build table headers based on filtered meters and change column preference
            tableHeaderTransformerRow.innerHTML = '';
            tableHeaderMeterRow.innerHTML = '';

            // Always add the Month header
            const monthHeader = document.createElement('th');
            monthHeader.textContent = 'Month';
            monthHeader.rowSpan = 2; // Spans both rows
            monthHeader.className = 'month-header'; // Apply specific style
            tableHeaderTransformerRow.appendChild(monthHeader);

            if (filteredData.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="no-data">No data found for the selected filters.</td></tr>';
                chartSection.classList.add('hidden');
                summaryMetrics.classList.add('hidden');
                anomalyAlerts.classList.add('hidden');
                return;
            }

            // Determine unique transformers from selected meters
            const uniqueTransformers = new Set();
            selectedMeters.forEach(meter => {
                const transformerMatch = meter.match(/\((T\d+)\)/);
                if (transformerMatch) {
                    uniqueTransformers.add(transformerMatch[1]);
                }
            });

            // Sort transformers numerically (T1, T2, T3...)
            const sortedTransformers = Array.from(uniqueTransformers).sort((a, b) => {
                const numA = parseInt(a.replace('T', ''));
                const numB = parseInt(b.replace('T', ''));
                return numA - numB;
            });

            // Build transformer and meter headers
            sortedTransformers.forEach(transformer => {
                const transformerMeters = selectedMeters.filter(meter => meter.includes(`(${transformer})`));
                if (transformerMeters.length > 0) {
                    const transformerTh = document.createElement('th');
                    transformerTh.colSpan = transformerMeters.length * (showChange ? 3 : 1); // Each meter gets Cons, MoM, YoY columns
                    transformerTh.textContent = transformer;
                    transformerTh.className = 'transformer-row-header'; // Add a class for styling
                    tableHeaderTransformerRow.appendChild(transformerTh);

                    transformerMeters.forEach(meter => {
                        const meterName = meter.replace(` (${transformer}) (Consumption)`, ''); // Extract just meter name (e.g., MAIN METER)
                        const meterTh = document.createElement('th');
                        meterTh.textContent = meterName + ' (kWh)';
                        meterTh.className = 'meter-row-header'; // Add a class for styling
                        tableHeaderMeterRow.appendChild(meterTh);

                        if (showChange) {
                            const momTh = document.createElement('th');
                            momTh.textContent = 'MoM%';
                            momTh.className = 'meter-row-header';
                            tableHeaderMeterRow.appendChild(momTh);

                            const yoyTh = document.createElement('th');
                            yoyTh.textContent = 'YoY%';
                            yoyTh.className = 'meter-row-header';
                            tableHeaderMeterRow.appendChild(yoyTh);
                        }
                    });
                }
            });

            // Populate table body
            tableBody.innerHTML = '';
            let totalConsumptionAllMeters = 0;
            const anomalyFindings = [];

            filteredData.forEach(row => {
                const tr = document.createElement('tr');
                const monthTd = document.createElement('td');
                monthTd.textContent = row.Month;
                tr.appendChild(monthTd);

                let rowTotalConsumption = 0; // Total consumption for the current row/month across selected meters

                sortedTransformers.forEach(transformer => {
                    const transformerMeters = selectedMeters.filter(meter => meter.includes(`(${transformer})`));
                    transformerMeters.forEach(meter => {
                        const consumption = parseFloat(row[meter]);
                        const consumptionTd = document.createElement('td');
                        consumptionTd.textContent = !isNaN(consumption) ? consumption.toFixed(2) : 'N/A';
                        tr.appendChild(consumptionTd);

                        if (!isNaN(consumption)) {
                            rowTotalConsumption += consumption; // Sum for overall total
                        }

                        if (showChange) {
                            const momChange = row[`${meter} MoM Change`];
                            const momTd = document.createElement('td');
                            momTd.textContent = momChange;
                            momTd.className = getChangeClass(momChange);
                            tr.appendChild(momTd);

                            const yoyChange = row[`${meter} YoY Change`];
                            const yoyTd = document.createElement('td');
                            yoyTd.textContent = yoyChange;
                            yoyTd.className = getChangeClass(yoyChange);
                            tr.appendChild(yoyTd);
                        }
                    });
                });
                totalConsumptionAllMeters += rowTotalConsumption; // Accumulate for overall sum

                if (enableAnomaly) {
                    availableMeters.forEach(meter => {
                        const currentConsumption = parseFloat(row[meter]);
                        if (!isNaN(currentConsumption)) {
                            const prevMonthsData = rawReportData.filter(d => {
                                const dDate = new Date(d.Month);
                                const rowDate = new Date(row.Month);
                                // Consider previous 3 months for the same meter
                                return dDate < rowDate && dDate.getMonth() !== rowDate.getMonth() && dDate.getFullYear() === rowDate.getFullYear();
                            }).slice(-3); // Get last 3 entries

                            if (prevMonthsData.length >= 3) {
                                const sumPrev = prevMonthsData.reduce((sum, d) => sum + (parseFloat(d[meter]) || 0), 0);
                                const averagePrev = sumPrev / prevMonthsData.length;

                                if (averagePrev > 0) {
                                    const deviation = ((currentConsumption - averagePrev) / averagePrev) * 100;
                                    if (Math.abs(deviation) > ANOMALY_THRESHOLD_PERCENT) {
                                        anomalyFindings.push(`${row.Month} - ${meter.replace(' (Consumption)', '')}: Consumption of ${currentConsumption.toFixed(2)} kWh is ${deviation.toFixed(2)}% ${deviation > 0 ? 'higher' : 'lower'} than previous 3-month average of ${averagePrev.toFixed(2)} kWh.`);
                                        // Highlight the row if an anomaly is detected in any meter for that month
                                        tr.classList.add('anomaly-highlight');
                                    }
                                }
                            }
                        }
                    });
                }
                tableBody.appendChild(tr);
            });

            // Display anomaly alerts
            if (enableAnomaly && anomalyFindings.length > 0) {
                anomalyAlerts.classList.remove('hidden');
                anomalyList.innerHTML = anomalyFindings.map(alert => `<div class="anomaly-item">${alert}</div>`).join('');
            } else {
                anomalyAlerts.classList.add('hidden');
                anomalyList.innerHTML = '';
            }


            // Show/hide summary metrics
            if (showSummary) {
                summaryMetrics.classList.remove('hidden');
                overallTotalConsumptionValue.textContent = totalConsumptionAllMeters.toFixed(2) + ' kWh';
                // Add more summary calculations here if needed
            } else {
                summaryMetrics.classList.add('hidden');
            }

            renderChart(filteredData, selectedMeters);
        }

        function getChangeClass(changeValue) {
            if (changeValue === 'N/A') return 'no-change';
            const num = parseFloat(changeValue);
            if (isNaN(num)) return 'no-change';
            if (num > 0) return 'positive-change';
            if (num < 0) return 'negative-change';
            return 'no-change';
        }

        function renderChart(data, selectedMeters) {
            console.log("renderChart: Data length:", data.length, "Selected Meters:", selectedMeters);
            if (myChart) {
                myChart.destroy(); // Destroy previous chart instance
            }

            if (data.length === 0 || selectedMeters.length === 0) {
                chartSection.classList.add('hidden');
                return;
            }

            chartSection.classList.remove('hidden');

            const chartLabels = data.map(row => row.Month);
            const datasets = [];
            const chartType = chartTypeFilter.value;

            // Sort selectedMeters based on desiredMeterOrder for consistent chart legend
            const sortedSelectedMeters = [...selectedMeters].sort((a, b) => {
                const indexA = desiredMeterOrder.indexOf(a);
                const indexB = desiredMeterOrder.indexOf(b);
                if (indexA === -1 && indexB === -1) return a.localeCompare(b);
                if (indexA === -1) return 1;
                if (indexB === -1) return -1;
                return indexA - indexB;
            });


            sortedSelectedMeters.forEach((meter, index) => {
                const consumptionData = data.map(row => parseFloat(row[meter]) || 0);
                datasets.push({
                    label: meter.replace(' (Consumption)', ''),
                    data: consumptionData,
                    backgroundColor: chartColors[index % chartColors.length],
                    borderColor: chartBorderColors[index % chartBorderColors.length],
                    borderWidth: 2,
                    fill: chartType === 'line' ? false : true, // Fill area for bar/doughnut/etc.
                    tension: 0.3 // For line charts, smooth lines
                });
            });

            // Trendline dataset (only for line/bar charts and if at least one meter is selected)
            if ((chartType === 'line' || chartType === 'bar') && sortedSelectedMeters.length > 0) {
                const primaryMeterData = data.map((row, i) => ({
                    x: i, // Use index as x-value for linear regression
                    y: parseFloat(row[sortedSelectedMeters[0]]) || 0
                }));
                const trendlinePoints = calculateLinearRegressionTrend(primaryMeterData);

                if (trendlinePoints.length === 2) {
                    datasets.push({
                        label: `Trendline (${sortedSelectedMeters[0].replace(' (Consumption)', '')})`,
                        data: [
                            { x: chartLabels[trendlinePoints[0].x], y: trendlinePoints[0].y },
                            { x: chartLabels[trendlinePoints[1].x], y: trendlinePoints[1].y }
                        ],
                        borderColor: 'rgba(255, 99, 132, 1)', // Red for trendline
                        borderWidth: 2,
                        borderDash: [5, 5], // Dashed line
                        fill: false,
                        type: 'line', // Ensure it's a line type even if overall chart is bar
                        pointRadius: 0, // No points for trendline
                        yAxisID: 'y'
                    });
                }
            }


            const chartConfig = {
                type: chartType,
                data: {
                    labels: chartLabels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: {
                                    size: 14
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: 'Electricity Consumption Over Time',
                            font: {
                                size: 18
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y.toFixed(2) + ' kWh';
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Consumption (kWh)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value + ' kWh';
                                }
                            }
                        }
                    }
                }
            };

            // Adjust options for non-Cartesian charts (Doughnut, Pie, Polar Area, Radar)
            if (['doughnut', 'pie', 'polarArea', 'radar'].includes(chartType)) {
                chartConfig.options.scales = {}; // Remove scales for these chart types
            }


            myChart = new Chart(consumptionChartCtx, chartConfig);
        }

        // Event Listeners
        applyFiltersBtn.addEventListener('click', applyFilters);
        resetFiltersBtn.addEventListener('click', () => {
            yearFilter.value = 'All';
            monthSelectOptions.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            meterSelectOptions.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            updateSelectTriggerText(monthSelectTrigger, monthSelectOptions, 'Months');
            updateSelectTriggerText(meterSelectTrigger, meterSelectOptions, 'Meters');
            chartTypeFilter.value = 'line';
            showChangeColumnsCheckbox.checked = false;
            showSummaryMetricsCheckbox.checked = false;
            showAnomalyDetectionCheckbox.checked = false;
            applyFilters();
        });
        downloadReportBtn.addEventListener('click', () => {
            const wb = XLSX.utils.table_to_book(reportTable, { sheet: "Report" });
            XLSX.writeFile(wb, "Electricity_Report.xlsx");
        });
        printReportBtn.addEventListener('click', () => {
            window.print();
        });


        // Initialize on load
        document.addEventListener('DOMContentLoaded', fetchGoogleSheetData);
    </script>
<script>
const scriptURL = 'https://script.google.com/macros/s/AKfycbz7lidciBT-Yz4nesxZ1s23gDvnCMWxL60CpvENMUYorVtGoKBryb24zp-omMgPhjPszA/exec';

fetch(scriptURL)
  .then(response => {
    if (!response.ok) throw new Error('Network response was not ok');
    return response.text();
  })
  .then(csv => {
    const rows = csv.trim().split('\n').map(row => row.split(','));
    const tableHead = document.getElementById('table-head');
    const tableBody = document.getElementById('table-body');
    tableHead.innerHTML = '';
    tableBody.innerHTML = '';

    // Create table headers
    const headers = rows[0];
    const headerRow = document.createElement('tr');
    headers.forEach(header => {
      const th = document.createElement('th');
      th.textContent = header;
      headerRow.appendChild(th);
    });
    tableHead.appendChild(headerRow);

    // Create table rows
    let totalConsumption = 0;
    for (let i = 1; i < rows.length; i++) {
      const row = document.createElement('tr');
      rows[i].forEach((cell, index) => {
        const td = document.createElement('td');
        td.textContent = cell;
        row.appendChild(td);

        if (headers[index].toLowerCase().includes('consumption')) {
          const value = parseFloat(cell);
          if (!isNaN(value)) totalConsumption += value;
        }
      });
      tableBody.appendChild(row);
    }

    const totalElem = document.getElementById('total-consumption');
    if (totalElem) {
      totalElem.textContent = totalConsumption.toFixed(2);
    }
  })
  .catch(error => {
    console.error('Fetch error:', error);
    const tableBody = document.getElementById('table-body');
    tableBody.innerHTML = `<tr><td colspan="5">Error loading data: ${error.message}</td></tr>`;
  });
</script></body>
</html>
